name: Deploy Backend to Server

on:
  push:
    branches:
      - main
      - master
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch: # Allows manual trigger from GitHub Actions UI

# This workflow deploys the backend without Docker, using PM2 directly

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          sshpass -p "${SERVER_PASSWORD}" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts ${SERVER_USER}@${SERVER_HOST} bash -s << EOF
            set -e

            SERVER_PATH="${SERVER_PATH:-/opt/qmenus/qmenus-backend}"

            echo "ğŸš€ Starting deployment..."
            echo "ğŸ“ Server path: ${SERVER_PATH}"

            # Navigate to backend directory
            cd "${SERVER_PATH}"

            # If SERVER_PATH points to root project, navigate to backend subdirectory
            if [ -d "backend" ] && [ ! -f "pm2.config.js" ]; then
              echo "ğŸ“‚ Navigating to backend subdirectory..."
              cd backend
            fi

            # Pull latest changes (ignore local changes)
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin
            CURRENT_BRANCH=\$(git rev-parse --abbrev-ref HEAD)
            git reset --hard origin/\${CURRENT_BRANCH} || git reset --hard origin/main || git reset --hard origin/master

            # Backup current .env file if it exists
            if [ -f .env ]; then
              echo "ğŸ’¾ Backing up .env file..."
              cp .env .env.backup.\$(date +%Y%m%d_%H%M%S)
            fi

            # Create necessary directories
            echo "ğŸ“ Creating directories..."
            mkdir -p nginx/logs
            mkdir -p api-service/logs
            mkdir -p socket-service/logs
            mkdir -p jobs-service/logs

            # Check if Node.js is installed
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.js is not installed. Installing Node.js 20..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            NODE_VERSION=\$(node --version)
            echo "âœ… Node.js version: \${NODE_VERSION}"

            # Check if PM2 is installed globally
            if ! command -v pm2 &> /dev/null; then
              echo "ğŸ“¦ Installing PM2 globally..."
              sudo npm install -g pm2
            fi

            # Install dependencies
            echo "ğŸ“¦ Installing root dependencies..."
            npm install

            # Install shared dependencies
            echo "ğŸ“¦ Installing shared dependencies..."
            cd shared
            npm install
            cd ..

            # Install api-service dependencies
            echo "ğŸ“¦ Installing api-service dependencies..."
            cd api-service
            npm install
            cd ..

            # Install socket-service dependencies
            echo "ğŸ“¦ Installing socket-service dependencies..."
            cd socket-service
            npm install
            cd ..

            # Install jobs-service dependencies
            echo "ğŸ“¦ Installing jobs-service dependencies..."
            cd jobs-service
            npm install
            cd ..

            # Generate Prisma Client
            echo "ğŸ”§ Generating Prisma Client..."
            cd shared
            npx prisma@5.22.0 generate --schema ./prisma/schema.prisma
            cd ..

            # Build all services
            echo "ğŸ”¨ Building all services..."
            npm run build:all

            # Run database migrations
            echo "ğŸ—„ï¸  Running database migrations..."
            cd shared
            npx prisma@5.22.0 migrate deploy --schema ./prisma/schema.prisma || echo "âš ï¸  Migration skipped or failed"
            cd ..

            # Seed database if needed
            echo "ğŸŒ± Checking database seed..."
            cd api-service
            node scripts/check-and-seed.js || echo "âš ï¸  Seed skipped or failed"
            cd ..

            # Stop existing PM2 processes
            echo "ğŸ›‘ Stopping existing PM2 processes..."
            pm2 stop pm2.config.js || true
            pm2 delete pm2.config.js || true

            # Start services with PM2
            echo "â–¶ï¸  Starting services with PM2..."
            pm2 start pm2.config.js

            # Save PM2 configuration
            pm2 save

            # Wait a bit for services to start
            echo "â³ Waiting for services to be ready..."
            sleep 5

            # Check PM2 status
            echo "ğŸ“Š PM2 Status:"
            pm2 status

            # Health check
            echo "ğŸ¥ Checking service health..."
            if pm2 list | grep -q "online"; then
              echo "âœ… Services are running!"

              # Test API health
              if command -v curl &> /dev/null; then
                echo "ğŸ” Testing API health endpoint..."
                curl -f http://localhost:5000/health || echo "âš ï¸  API health check failed"
              fi

              echo "âœ… Deployment successful!"
            else
              echo "âŒ Deployment failed - services are not running"
              echo "ğŸ“‹ PM2 logs:"
              pm2 logs --lines 50 --nostream
              exit 1
            fi

            echo "âœ¨ Deployment completed successfully!"
            echo "ğŸ“Š View logs with: pm2 logs"
            echo "ğŸ“Š View status with: pm2 status"
            echo "ğŸ”„ Restart services with: pm2 restart pm2.config.js"
          EOF

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Backend deployment completed successfully!"
          echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
          echo "ğŸ“ Path: ${{ secrets.SERVER_PATH }}"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Backend deployment failed!"
          echo "Please check the logs above for details."
