# Production Docker Compose Configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: "3.8"

services:
  nginx:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.qmenussy.com`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=80"

  backend:
    environment:
      NODE_ENV: production
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 1G
    restart: always

  postgres:
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
    restart: always

  redis:
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    restart: always

secrets:
  postgres_password:
    external: true
