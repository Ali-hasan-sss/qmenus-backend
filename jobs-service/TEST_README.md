# Jobs Service Tests

## التثبيت

قبل تشغيل الاختبارات، تأكد من تثبيت جميع الحزم:

```bash
cd backend/jobs-service
npm install
```

## تشغيل الاختبارات

### تشغيل جميع الاختبارات:

```bash
npm test
```

### تشغيل الاختبارات في وضع Watch (مراقبة التغييرات):

```bash
npm run test:watch
```

### تشغيل الاختبارات مع تقرير التغطية:

```bash
npm run test:coverage
```

## الاختبارات المتوفرة

### 1. `checkExpiringSubscriptions`

- ✅ يجد الاشتراكات التي ستنتهي خلال 24 ساعة
- ✅ يرسل إشعارات للمطعم والأدمن
- ✅ لا يرسل إشعارات مكررة
- ✅ يتعامل مع الاشتراكات التي تنتهي بعد أكثر من يوم

### 2. `checkExpiredSubscriptions`

- ✅ يجد الاشتراكات المنتهية
- ✅ يغير حالة الاشتراك إلى `EXPIRED`
- ✅ يعطل المطعم إذا لم يكن لديه اشتراكات نشطة أخرى
- ✅ لا يعطل المطعم إذا كان لديه اشتراكات نشطة أخرى
- ✅ يتعامل مع الاشتراكات التي `endDate` هو `null`
- ✅ يتعامل مع الأخطاء بشكل صحيح

### 3. `runDailySubscriptionChecks`

- ✅ يشغل كلا من `checkExpiringSubscriptions` و `checkExpiredSubscriptions`
- ✅ يرجع النتائج بشكل صحيح

### 4. Edge Cases

- ✅ يتعامل مع الاشتراكات التي تنتهي بالضبط بعد 24 ساعة
- ✅ يتعامل مع عدة اشتراكات منتهية لنفس المطعم

## ملاحظات

- الاختبارات تستخدم Mock لـ Prisma client
- الاختبارات لا تتطلب اتصال بقاعدة البيانات
- جميع الاختبارات مستقلة ويمكن تشغيلها بشكل منفصل
