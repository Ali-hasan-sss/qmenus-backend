#!/bin/bash

# ุณูุฑูุจุช ุชุญุฏูุซ ุงููุดุฑูุน ุนูู VPS
# ุงูุงุณุชุฎุฏุงู: ./scripts/update.sh

set -e  # ุฅููุงู ุนูุฏ ุญุฏูุซ ุฎุทุฃ

echo "๐ ุจุฏุก ุนูููุฉ ุงูุชุญุฏูุซ..."

# ุงูุฃููุงู ููุฑุณุงุฆู
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงููุดุฑูุน
cd "$(dirname "$0")/.."

# ุงูุชุญูู ูู ูุฌูุฏ Git
if [ -d .git ]; then
    echo -e "${GREEN}๐ฅ ุณุญุจ ุงูุชุญุฏูุซุงุช ูู Git...${NC}"
    git pull
else
    echo -e "${YELLOW}โ๏ธ  ูุฐุง ุงููุฌูุฏ ููุณ ูุณุชูุฏุน Git. ุณูุชู ุงููุชุงุจุนุฉ ุจุฏูู ุณุญุจ ุงูุชุญุฏูุซุงุช.${NC}"
fi

echo -e "${GREEN}๐ฆ ุชุซุจูุช ุงูุชุจุนูุงุช ุงูุฌุฏูุฏุฉ...${NC}"
npm install --production

echo -e "${GREEN}๐๏ธ  ุชุดุบูู Migrations ุงูุฌุฏูุฏุฉ...${NC}"
npm run db:deploy || echo -e "${YELLOW}โ๏ธ  ูุง ุชูุฌุฏ migrations ุฌุฏูุฏุฉ${NC}"

echo -e "${GREEN}๐จ ุจูุงุก ุงููุดุฑูุน...${NC}"
npm run build:all

echo -e "${GREEN}๐ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุงุช...${NC}"
pm2 restart ecosystem.config.js

echo -e "${GREEN}โ ุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ!${NC}"
echo ""
echo "๐ ุนุฑุถ ุญุงูุฉ ุงูุฎุฏูุงุช: pm2 status"
echo "๐ ุนุฑุถ ุงูุณุฌูุงุช: pm2 logs"

